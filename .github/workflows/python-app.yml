name: Build and Upload Flask App Artifact

on:
  push:
    branches: 
      - main
      - master
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.8'

    - name: Cache Poetry virtualenv
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pypoetry/virtualenvs
          .venv
        key: poetry-${{ runner.os }}-${{ hashFiles('**/poetry.lock', '**/pyproject.toml') }}
        restore-keys: |
          poetry-${{ runner.os }}-

    - name: Install Poetry
      run: |
        pip install poetry

    - name: Install dependencies
      run: |
        poetry install

    - name: Determine semantic version
      id: get_version
      run: |
        VERSION=$(git describe --tags --abbrev=0 || echo "0.1.0")
        echo "$VERSION" > VERSION

    - name: Build artifact
      run: |
        mkdir artifact
        cp -r * artifact/
        rm -rf artifact/venv artifact/__pycache__
        cp VERSION artifact/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: flask-app-artifact
        path: artifact 
